<!DOCTYPE html>
<html>
	<head>
		<title>OptiCoin</title>
		<script src="OptiCoin.js"></script>
		<style>
			#visual {
				background-color: #000;
			}

			#layout {
				margin-top: 16px;
				background-color: #9cf;
				border-radius: 4px;
			}

			#layout th, #layout td {
				text-align: left;
				padding: 8px;
				color: #333;
				vertical-align: top;
			}

			#layout th:last-child {
				width: 200px;
			}
		</style>
	</head>
	<body>
		
		show:
		<select onchange="show(this.selectedIndex);">
			<option>Original</option>
			<option>Color Mask / Threshold</option>
			<option>Segmentation</option>
			<option>Edge Filter</option>
			<option>Points of Interest</option>
			<option>Alignment</option>
			<option>Features</option>
			<option>Data Extraction</option>
			<option>Results</option>
		</select>

		<table id="layout">
			<thead>
				<tr>
					<th>visual</th>
					<th>coin info</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>
						<canvas id="visual" width="1000" height="566"></canvas>
					</td>
					<td>
						N/A
					</td>
				</tr>
			</tbody>
		</table>

		<script>
			var display = document.getElementById('visual').getContext('2d');
			var input = new Image();
			input.src = 'many pennies.png';
			var cnvs = document.createElement('canvas');
			cnvs.width = 2140;
			cnvs.height = 1212;
			var ctx = cnvs.getContext('2d');
			var step = 0;

			function paint() {
				ctx.drawImage(input, 0, 0);

				if(step == 0)
					display.drawImage(input, 0, 0, 2140, 1212, 0, 0, 1000, 566);
				else if(step > 0) {
					var buff = ctx.getImageData(0, 0, 2140, 1212);
					OptiCoin.vectorThreshold(buff, 37, 148, 199, 0.1, 1);
					
					if(step == 1) {
						ctx.putImageData(buff, 0, 0);
						display.drawImage(cnvs, 0, 0, 2140, 1212, 0, 0, 1000, 566);
					}
					else { //Step > 1
						var segments = OptiCoin.extractSegments(buff, 16, 8);

						if(step == 2) {
							display.drawImage(input, 0, 0, 2140, 1212, 0, 0, 1000, 566);

							display.lineWidth = 4;
							for(var i = 0; i < segments.length; ++i) {
								display.strokeStyle = randColor(1);
								display.beginPath();
								display.arc(segments[i].centerX * 1000 / 2140, segments[i].centerY * 1000 / 2140, (segments[i].maxX - segments[i].minX) / 2 * (1000 / 2140), 0, 2 * Math.PI, true);
								display.closePath();
								display.stroke();
							}
						}
						else { //Step > 2
							var segment = segments[0];
							var segX = segment.minX -12;
							var segY = segment.minY -12;
							var segWidth = segment.maxX - segment.minX + 24;
							var segHeight = segment.maxY - segment.minY + 24;

							var buff = ctx.getImageData(segX, segY, segWidth, segHeight);
							OptiCoin.convolve(buff, OptiCoin.Kernel.GAUSSIAN_BLUR);
							OptiCoin.convolve(buff, OptiCoin.Kernel.EDGE);
							OptiCoin.threshold(buff, 96);

							display.clearRect(0, 0, 1000, 566);
							display.putImageData(buff, (1000 - segWidth) / 2, (566 - segHeight) / 2, 0, 0, segWidth, segHeight - 1);
						}
					}
				}

			}
			input.onload = paint;

			function show(index) {
				step = index;
				paint();
			}

			function randColor(alpha) {
				var r = rand255();
				var g = rand255();
				var b = rand255();
				return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + alpha + ')';
			}

			function rand255() {
				return ~~(255 * Math.random())
			}
		</script>

	</body>
</html>